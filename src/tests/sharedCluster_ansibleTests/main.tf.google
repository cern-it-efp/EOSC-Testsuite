variable "credentials" {
  default = ""
}
variable "image" {
  default = "centos-cloud/centos-7"
  #default = "ubuntu-1804-bionic-v20200108"
}
variable "openUser" {
  default = "openu"
}
variable "pathToKey" {
  default = "~/.ssh/id_rsa"
}

provider "google" {
  credentials = file(var.credentials)
  project     = "ocrets"
}

resource "google_compute_instance" "kubenode" {

  count        = 2
  machine_type = "n1-standard-2"
  name         = "ansiblevm-${count.index}"
  zone         = "us-west1-a"

  boot_disk {
    initialize_params {
      image = var.image
      size  = 100
    }
  }
  network_interface {
    network = "default"
    access_config {}
  }

  scheduling {
    on_host_maintenance = "TERMINATE"
  }
}

resource "null_resource" "allow_root" {
  count = 2
  provisioner "remote-exec" {
    connection {
      host        = element(google_compute_instance.kubenode.*.network_interface.0.network_ip, count.index)
      type        = "ssh"
      user        = var.openUser
      private_key = file(var.pathToKey)
      timeout     = "20m"
    }
    inline = [
      "sudo mkdir /root/.ssh",
      "sudo cp /home/${var.openUser}/.ssh/authorized_keys /root/.ssh",
      "sudo sed -i '1iPermitRootLogin yes\n' /etc/ssh/sshd_config",
      "sudo systemctl restart sshd || sudo service sshd restart"
    ]
  }
}
