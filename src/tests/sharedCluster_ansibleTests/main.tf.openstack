provider "openstack" {
}

variable "openUser" {
  default = "eouser"
}
variable "pathToKey" {
  default = "/root/.ssh/id_rsa"
}
variable "image" {
  default = "CentOS 7"
  #default = "Ubuntu 18.04 LTS"
}

resource "openstack_compute_instance_v2" "kubenode" {
  count                 = 2
  flavor_name           = "eo1.medium"
  name                  = "ansiblevm-${count.index}"
  image_name = var.image
  key_pair = "mykey"
  security_groups = ["default","allow_ping_ssh_rdp"]
}

resource "null_resource" "allow_root" {
  count = 2
  provisioner "remote-exec" {
    connection {
      host        = openstack_compute_instance_v2.kubenode[count.index].network[0].fixed_ip_v4
      type        = "ssh"
      user        = var.openUser
      private_key = file(var.pathToKey)
      timeout     = "20m"
    }
    inline = [
      "sudo mkdir /root/.ssh",
      "sudo cp /home/${var.openUser}/.ssh/authorized_keys /root/.ssh",
      "sudo sed -i '1iPermitRootLogin yes\n' /etc/ssh/sshd_config",
      "sudo systemctl restart sshd || sudo service sshd restart"
    ]
  }
}
